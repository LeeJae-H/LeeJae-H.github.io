---
layout: post
title: (Tomcat) - ServletContainerInitializer를 사용한 서블릿 컨테이너 설정 (+web.xml) (+ServletContext, ServletConfig)
date: 2024-05-10
categories: [tomcat]
---
### ServletContainerInitializer
```java
public interface ServletContainerInitializer 
{
    void onStartup(Set<Class<?>> var1, ServletContext var2) throws ServletException;
}
```
- Servlet 3.0부터 ServletContainerInitializer의 등장으로 기존의 web.xml 기반 대신 코드 기반으로 <span style="color:red">서블릿 컨테이너 설정(서블릿 등록 및 매핑, ServletContext 객체 초기화 등)</span>이 가능해졌다. 
    - ServletContainerInitializer 인터페이스를 구현하는 클래스를 만든 후, /META-INF/services/jakarta.servlet.ServletContainerInitializer 파일을 생성하고 ServletContainerInitializer 인터페이스를 구현한 클래스의 이름을 해당 파일에 적어준다.
    - ServletContainerInitializer 인터페이스를 구현하는 클래스에 @HandlesTypes 어노테이션으로 클래스를 지정해주면, 서블릿 컨테이너가 시작될 때 지정된 클래스를 찾아서 ServletContainerInitializer 인터페이스를 구현하는 클래스의 onStartup() 메소드에 지정된 클래스와 ServletContext 객체를 인자로 넣어준다.  

---
> - <span style="color:red">서블릿 컨테이너가 시작될 때</span> 서블릿 컨테이너를 설정하는 작업들 중 두 가지 주요 작업인 <span style="color:blueviolet">"서블릿 등록 및 매핑"과 "ServletContext 객체 초기화"에 대해서 몇 가지 방식의 예시</span>를 살펴보자.

### 서블릿 등록 및 매핑
1. **ServletContainerInitializer 방식**
    - 웹 애플리케이션 구조
        ```bash
/src
        /main
          /java
            /com
              /example
                ExampleServlet.java
                MyServletContainerInitializer.java
                MyAppInitializer.java
                MyAppInitializerV1.java
          /resources
            /META-INF
              /services
                jakarta.servlet.ServletContainerInitializer
        ``` 
    - 서블릿 클래스 생성
        ```java
        public class ExampleServlet extends HttpServlet 
        {
            @Override
            protected void service(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException
                {
                    System.out.println("servce() 메소드 호출");
                }    
        }
        ```
    - ServletContainerInitializer 구현 클래스 생성
        ```java
        @HandlesTypes(MyAppInitializer.class)
        public class MyServletContainerInitializer implements ServletContainerInitializer 
        {
            @Override
            public void onStartup(Set<Class<?>> classes, ServletContext servletContext) throws ServletException 
            {
                for (Class<?> myAppInitClass : classes) {
                    try {
                        MyAppInitializer initializer = (MyAppInitializer) myAppInitClass.getDeclaredConstructor.newInstance();
                        initializer.onStartup(servletContext);
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                }
            }
        }
        ```
    - /META-INF/services/jakarta.servlet.ServletContainerInitializer 파일 생성 후 아래 내용 작성
        ```bash
com.example.MyServletContainerInitializer
        ```  
    - MyAppInitializer 인터페이스 작성 및 구현
        ```java
        public interface MyAppInitializer
        {
            void onStartUp(ServletContext servletContext);
        }
        ```
        ```java
        public class MyAppInitializerV1 implements MyAppInitializer
        {
            @Override    
            public void onStartUp(ServletContext servletContext) 
            {
                ServletRegistration.Dynamic exampleServlet = servletContext.addServlet("exampleServlet", new ExampleServlet());
                exampleServlet.addMapping("/example);
            }
        }
        ```

2. **web.xml 방식** 
    - 웹 애플리케이션 구조
        ```bash
/src
        /main
          /java
            /com
              /example
                ExampleServlet.java
          /webapp
            /WEB-INF
              web.xml
        ``` 
    - 서블릿 클래스 생성
        ```java
        public class ExampleServlet extends HttpServlet 
        {
            @Override
            protected void service(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException
                {
                    System.out.println("servce() 메소드 호출");
                }    
        }
        ```
    - web.xml 작성
        ```xml
        ...
        <servlet>
            <servlet-name>exampleServlet</servlet-name>
            <servlet-class>com.example.ExampleServlet</servlet-class>
        </servlet>
        
        <servlet-mapping>
            <servlet-name>exampleServlet</servlet-name>
            <url-pattern>/example</url-pattern>
        </servlet-mapping>
        ...
        ```

3. **어노테이션(@WebServlet) 방식**    
    - 서블릿 클래스 생성(@WebServlet)
        ```java
        @WebServlet(name = "ExampleServlet", urlPatterns = "/example")
        public class ExampleServlet extends HttpServlet 
        {
            @Override
            protected void service(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException
                {
                    System.out.println("servce() 메소드 호출");
                }    
        }
        ```

### ServletContext 객체 초기화
> - <span style="color:red">**ServletContext 객체의 초기화**</span>   
    1. ServletContainerInitializer 방식
        - 서블릿 컨테이너(웹 애플리케이션)가 시작될 때, 서블릿 컨테이너는 <span style="color:blueviolet">ServletContainerInitializer 인터페이스를 구현한 클래스를 찾으면 해당 클래스를 로딩하고 인스턴스화한다. 이후 해당 클래스의 onStartup() 메소드를 호출하여 ServletContext 객체를 초기화</span>한다.  
    2. web.xml 방식
        - 서블릿 컨테이너(웹 애플리케이션)가 시작될 때, 서블릿 컨테이너는 <span style="color:blueviolet">web.xml을 읽은 후 ServletContext 객체를 초기화</span>한다.
    3. ServletContextListener 방식
        - 서블릿 컨테이너(웹 애플리케이션)가 시작될 때, 서블릿 컨테이너는 <span style="color:blueviolet">ServletContextListener 인터페이스를 구현한 클래스를 찾으면 해당 클래스를 로딩하고 인스턴스화한다. 이후 해당 클래스의 contextInitialized() 메소드를 호출하여 ServletContext 객체를 초기화</span>한다.  

1. **ServletContainerInitializer 방식**
    - ServletContainerInitializer 구현 클래스 생성
        ```java
        @HandlesTypes(MyAppInitializer.class)
        public class MyServletContainerInitializer implements ServletContainerInitializer 
        {
            @Override
            public void onStartup(Set<Class<?>> classes, ServletContext servletContext) throws ServletException 
            {
                for (Class<?> myAppInitClass : classes) {
                    try {
                        MyAppInitializer initializer = (MyAppInitializer) myAppInitClass.getDeclaredConstructor.newInstance();
                        initializer.onStartup(servletContext);
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                }
            }
        }
        ```
    - /META-INF/services/jakarta.servlet.ServletContainerInitializer 파일 생성 후 아래 내용 작성
        ```bash
com.example.MyServletContainerInitializer
        ```  
    - MyAppInitializer 인터페이스 작성 및 구현
        ```java
        public interface MyAppInitializer
        {
            void onStartUp(ServletContext servletContext);
        }
        ```
        ```java
        public class MyAppInitializerV1 implements MyAppInitializer
        {
            @Override    
            public void onStartUp(ServletContext servletContext) 
            {
                // setInitParamater와 setAtturibute는 용도와 동작 방식 측면에서 여러 차이가 있음
                servletContext.setInitParameter("test1", "hi");
                servletContext.setAttribute("test2", "hello");
                ServletRegistration.Dynamic exampleServlet = servletContext.addServlet("exampleServlet", new ExampleServlet());
                exampleServlet.addMapping("/example);
            }
        }
        ```
  
    > - <span style="color:red">setInitParameter() VS setAttribute()</span>
        - setInitParamter() 
            - 설정 후 변경 불가 -> 이미 해당 초기화 파라미터가 설정되있으면 실패함
            - 설정은 주로 초기화 시에 한 번만 수행
            - 웹 애플리케이션의 전역 설정에 주로 사용
            - <span style="color:blueviolet">web.xml의 context-param 태그와 유사함 -> 읽기 전용</span>
        - setAttribute()
            - 설정, 변경, 제거 가능
            - 런타임 동안 동적으로 관리
            - 애플리케이션 컴포넌트 간 데이터 공유 및 상태 저장에 주로 사용   

2. **web.xml 방식**
    - web.xml 작성
        ```xml
        ...
        <context-param>
            <param-name>test1</param-name>
            <param-value>hi</param-value>
        </context-param>
        
        <context-param>
            <param-name>test2</param-name>
            <param-value>hello</param-value>
        </context-param>

        <servlet>
            <servlet-name>exampleServlet</servlet-name>
            <servlet-class>com.example.ExampleServlet</servlet-class>
        </servlet>

        <servlet-mapping>
            <servlet-name>exampleServlet</servlet-name>
            <url-pattern>/example</url-pattern>
        </servlet-mapping>
        ...
        ```

3. **ServletContextListener 방식**  
    **3-1. 어노테이션 방식**   
    - ServletContextListener 인터페이스 구현 클래스 생성(@WebListener)  
        ```java
        @WebListener
        public class MyServletContextListener implements ServletContextListener 
        {
            @Override
            public void contextInitialized(ServletContextEvent sce) 
            {
                ServletContext context = sce.getServletContext();
                context.setInitParameter("test1", "hi");
                context.setAttribute("test2", "hello");
            }
        }
        ```

    **3-2. web.xml과 함께 사용하는 방식**  
    - ServletContextListener 인터페이스 구현 클래스 생성
        ```java
        public class MyServletContextListener implements ServletContextListener 
        {
            @Override
            public void contextInitialized(ServletContextEvent sce) 
            {
                ServletContext context = sce.getServletContext();
                context.setInitParameter("test1", "hi");
                context.setAttribute("test2", "hello");
            }
        }
        ```
    - web.xml 작성
        ```xml
        ...
        <listener>
            <listener-class>com.example.MyServletContextListener</listener-class>
        </listener>
        ...
        ```


---
참고 자료  
https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/ServletContainerInitializer.html  
https://tomcat.apache.org/tomcat-8.0-doc/servletapi/javax/servlet/ServletContext.html  
https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/ServletRegistration.Dynamic.html  
https://tomcat.apache.org/tomcat-8.5-doc/servletapi/javax/servlet/ServletContextListener.html  
https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/SpringServletContainerInitializer.html  
https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/WebApplicationInitializer.html  
https://kimcoder.tistory.com/511  
https://recordsoflife.tistory.com/490  
https://escapefromcoding.tistory.com/174  
https://offbyone.tistory.com/215  
https://nhs0912.tistory.com/81  
https://blog.naver.com/kitepc/221314687808  
https://velog.io/@rolroralra/Chapter0.-Servlet-컨테이너-Spring-컨테이너   
https://amy-it.tistory.com/86  
https://erjuer.tistory.com/20  
https://scshim.tistory.com/399  